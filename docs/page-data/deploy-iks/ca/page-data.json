{"componentChunkName":"component---src-pages-deploy-iks-ca-index-mdx","path":"/deploy-iks/ca/","result":{"pageContext":{"frontmatter":{"title":"Cluster AutoScaler (CA)","description":"Overview","keywords":"ibm cloud iks scaling ca autoscaling"},"relativePagePath":"/deploy-iks/ca/index.mdx","titleType":"page","MdxNode":{"id":"4f892a31-1ddd-534e-bd5b-733645c4b119","children":[],"parent":"590d1119-6cda-5903-b8d5-92b8efb9f0d6","internal":{"content":"---\ntitle: Cluster AutoScaler (CA)\ndescription: Overview \nkeywords: 'ibm cloud iks scaling ca autoscaling'\n---\n\nThe cluster autoscaler is available for standard clusters that are set up with public network connectivity. With the `ibm-iks-cluster-autoscaler` plug-in, you can scale the worker pools in your IBM Cloud Kubernetes Service cluster automatically to increase or decrease the number of worker nodes in the worker pool based on the sizing needs of your scheduled workloads.\n\n## Install the cluster autoscaler plug-in using Helm Chart\n\nThe environment should be set for the cluster which you want to autoscale as explined in `Environment Setup` section.\nOnce environment is ready, follow the below steps:\n\n- Confirm that your IBM Cloud Identity and Access Management credentials are stored in the cluster.\n\n  ```bash\n  kubectl get secrets -n kube-system | grep storage-secret-store\n  ```\n\n- The cluster autoscaler can scale only worker pools that have the `ibm-cloud.kubernetes.io/worker-pool-id`label. Check whether your worker pool has the required label.\n\n  ```bash\n\n  # To get Cluster name or ID\n  ibmcloud ks cluster ls\n\n  # To get Worker-Pool name or ID for your cluster\n  ibmcloud ks worker-pool ls -c <cluster_name_or_ID>\n\n  # To check Label of the worker-pool\n  ibmcloud ks worker-pool get --cluster <cluster_name_or_ID> --worker-pool <worker_pool_name_or_ID> | grep Labels\n  ```\n\n- Install `Helm v3` by following the [instructions](https://cloud.ibm.com/docs/containers?topic=containers-helm#install_v3). You can skip this step if you already have helmv3 installed.\n\n- Add and update the Helm repo where the cluster autoscaler Helm chart is.\n\n  ```bash\n  helm repo add iks-charts https://icr.io/helm/iks-charts\n  helm repo update\n  ```\n\n- Install the cluster autoscaler Helm chart in the `kube-system` namespace of your cluster. In the example command, the default worker pool is enabled for autoscaling with the Helm chart installation.\n\n  ```bash\n  helm install ibm-iks-cluster-autoscaler iks-charts/ibm-iks-cluster-autoscaler --namespace kube-system --set workerpools[0].default.max=4,workerpools[0].default.min=2,workerpools[0].default.enabled=true\n  ```\n  \n  Here, the first workerpool named as default is enabled for autoscaling with maximum number of nodes as 4 and 2 minimum number of worker nodes. To customize and understand more `--set workerpools` options, please refer this [link](https://cloud.ibm.com/docs/containers?topic=containers-ca#ca_helm).\n\n- Verify that the installation is successful.\n  - Check that the cluster autoscaler pod is in a Running state.\n    ```bash\n    kubectl get pods --namespace=kube-system | grep ibm-iks-cluster-autoscaler\n    ```\n\n  - Check that the cluster autoscaler service is created.\n    ```bash\n    kubectl get service --namespace=kube-system | grep ibm-iks-cluster-autoscaler\n    ```\n\n  - The worker pool details are added to the cluster autoscaler config map. Verify that the config map is correct by checking that the `workerPoolsConfig.json` field is updated and that the `workerPoolsConfigStatus` field shows a success message.\n    ```bash\n    kubectl get cm iks-ca-configmap -n kube-system -o yaml\n    ```\n\n<InlineNotification>\n  \nThe more detailed instructions are provided at https://cloud.ibm.com/docs/containers?topic=containers-ca#ca_helm . Please follow the link to get more details of each step and to customize the cluster autoscaler settings.\n\n</InlineNotification>\n\n## Scaling up Worker nodes\n\nA pod is considered pending when insufficient compute resources exist to schedule the pod on a worker node. When the cluster autoscaler detects pending pods, the autoscaler scales up your worker nodes to meet the workload resource requests.\n\n- Deploy the application as explained in `Deploy Application to IKS` section.\n\n- Create a deployment such that the worker pool runs out of resources and some of the pods will be in pending state which then triggers the cluster autoscaler to scale up the worker pool. Execute the following steps to increase load using `hpa` resource.\n  \n  ```bash\n  # configure hpa\n  kubectl autoscale deployment test --cpu-percent=25 --min=1 --max=25\n  \n  # modify yaml for ingress subdomain\n  sed -i '' s#HOST#<YOUR_INGRESS_SUBDOMAIN># generate-load-ca.yaml  //mac\n  OR\n  sed -i s#HOST#<YOUR_INGRESS_SUBDOMAIN># generate-load-ca.yaml     //linux\n  \n  kubectl create -f generate-load-ca.yaml\n  ```\n\n  <InlineNotification>\n\n  Check out the **Horizontal Pod AutoScaling** section to understand more about **hpa**.\n\n  </InlineNotification>\n\n- The above step should result some of the pods in `pending` state. Keep checking the following command. \n\n  ```bash\n  # to check pods and their state\n  kubectl get pods\n\n  # to check the number of replicas\n  kubectl get hpa\n  ```\n\n- Verify if cluster autoscaler has triggered using the following command.\n\n  ```bash\n  # if it shows Workers > 1 then Cluster Autoscaler has been triggered successfully\n  ibmcloud ks worker-pool ls --cluster <cluster_name_or_ID>\n  ```\n\n  You can check the IBM Cloud Dashboard to confirm if worker nodes are created to meet the current demand. The dashboard will show something like this snapshot.\n  \n  ![Scalingup Nodes](./images/dashboard-scale-up.png)\n\n  It will take few minutes for a new worker node to get ready. You can also follow along with the pod deployment from the command line. You should see the pods transition from pending to running as nodes are scaled up. After sometime all four worker nodes will be up and running. \n\n## Scaling down Worker nodes\n\nThe cluster autoscaler periodically scans the cluster to adjust the number of worker nodes within the worker pools. If the cluster autoscaler detects underutilized worker nodes, it scales down your worker nodes one at a time so that you have only the compute resources that you need.\n\nDecrease the load using the following command.\n\n```bash\nkubectl delete -f generate-load-ca.yaml\n```\n\nWhen the load decreases, the number of pods will also decrease which internally freed up the worker nodes. After a short period of time, the cluster autoscaler detects that your cluster no longer needs all its compute resources and scales down the worker nodes one at a time. Check the Kubernetes dashboard after sometime, you can see the that nodes are getting deleted.\n\n![ScalingDown Nodes](./images/dashboard-scale-down.png)\n\nWe setup 2 as minimum number of worker nodes, it means that the cluster autoscaler does not scale down below two worker nodes  even if you remove the workload that requests the amount. Hence check the dashboard after sometime, it will show as below snapshot.\n\n![Dashboard](./images/dashboard-iks.png)","type":"Mdx","contentDigest":"1db0d89d6f0ac4bb143fc2df7f2cc641","counter":618,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"Cluster AutoScaler (CA)","description":"Overview","keywords":"ibm cloud iks scaling ca autoscaling"},"exports":{},"rawBody":"---\ntitle: Cluster AutoScaler (CA)\ndescription: Overview \nkeywords: 'ibm cloud iks scaling ca autoscaling'\n---\n\nThe cluster autoscaler is available for standard clusters that are set up with public network connectivity. With the `ibm-iks-cluster-autoscaler` plug-in, you can scale the worker pools in your IBM Cloud Kubernetes Service cluster automatically to increase or decrease the number of worker nodes in the worker pool based on the sizing needs of your scheduled workloads.\n\n## Install the cluster autoscaler plug-in using Helm Chart\n\nThe environment should be set for the cluster which you want to autoscale as explined in `Environment Setup` section.\nOnce environment is ready, follow the below steps:\n\n- Confirm that your IBM Cloud Identity and Access Management credentials are stored in the cluster.\n\n  ```bash\n  kubectl get secrets -n kube-system | grep storage-secret-store\n  ```\n\n- The cluster autoscaler can scale only worker pools that have the `ibm-cloud.kubernetes.io/worker-pool-id`label. Check whether your worker pool has the required label.\n\n  ```bash\n\n  # To get Cluster name or ID\n  ibmcloud ks cluster ls\n\n  # To get Worker-Pool name or ID for your cluster\n  ibmcloud ks worker-pool ls -c <cluster_name_or_ID>\n\n  # To check Label of the worker-pool\n  ibmcloud ks worker-pool get --cluster <cluster_name_or_ID> --worker-pool <worker_pool_name_or_ID> | grep Labels\n  ```\n\n- Install `Helm v3` by following the [instructions](https://cloud.ibm.com/docs/containers?topic=containers-helm#install_v3). You can skip this step if you already have helmv3 installed.\n\n- Add and update the Helm repo where the cluster autoscaler Helm chart is.\n\n  ```bash\n  helm repo add iks-charts https://icr.io/helm/iks-charts\n  helm repo update\n  ```\n\n- Install the cluster autoscaler Helm chart in the `kube-system` namespace of your cluster. In the example command, the default worker pool is enabled for autoscaling with the Helm chart installation.\n\n  ```bash\n  helm install ibm-iks-cluster-autoscaler iks-charts/ibm-iks-cluster-autoscaler --namespace kube-system --set workerpools[0].default.max=4,workerpools[0].default.min=2,workerpools[0].default.enabled=true\n  ```\n  \n  Here, the first workerpool named as default is enabled for autoscaling with maximum number of nodes as 4 and 2 minimum number of worker nodes. To customize and understand more `--set workerpools` options, please refer this [link](https://cloud.ibm.com/docs/containers?topic=containers-ca#ca_helm).\n\n- Verify that the installation is successful.\n  - Check that the cluster autoscaler pod is in a Running state.\n    ```bash\n    kubectl get pods --namespace=kube-system | grep ibm-iks-cluster-autoscaler\n    ```\n\n  - Check that the cluster autoscaler service is created.\n    ```bash\n    kubectl get service --namespace=kube-system | grep ibm-iks-cluster-autoscaler\n    ```\n\n  - The worker pool details are added to the cluster autoscaler config map. Verify that the config map is correct by checking that the `workerPoolsConfig.json` field is updated and that the `workerPoolsConfigStatus` field shows a success message.\n    ```bash\n    kubectl get cm iks-ca-configmap -n kube-system -o yaml\n    ```\n\n<InlineNotification>\n  \nThe more detailed instructions are provided at https://cloud.ibm.com/docs/containers?topic=containers-ca#ca_helm . Please follow the link to get more details of each step and to customize the cluster autoscaler settings.\n\n</InlineNotification>\n\n## Scaling up Worker nodes\n\nA pod is considered pending when insufficient compute resources exist to schedule the pod on a worker node. When the cluster autoscaler detects pending pods, the autoscaler scales up your worker nodes to meet the workload resource requests.\n\n- Deploy the application as explained in `Deploy Application to IKS` section.\n\n- Create a deployment such that the worker pool runs out of resources and some of the pods will be in pending state which then triggers the cluster autoscaler to scale up the worker pool. Execute the following steps to increase load using `hpa` resource.\n  \n  ```bash\n  # configure hpa\n  kubectl autoscale deployment test --cpu-percent=25 --min=1 --max=25\n  \n  # modify yaml for ingress subdomain\n  sed -i '' s#HOST#<YOUR_INGRESS_SUBDOMAIN># generate-load-ca.yaml  //mac\n  OR\n  sed -i s#HOST#<YOUR_INGRESS_SUBDOMAIN># generate-load-ca.yaml     //linux\n  \n  kubectl create -f generate-load-ca.yaml\n  ```\n\n  <InlineNotification>\n\n  Check out the **Horizontal Pod AutoScaling** section to understand more about **hpa**.\n\n  </InlineNotification>\n\n- The above step should result some of the pods in `pending` state. Keep checking the following command. \n\n  ```bash\n  # to check pods and their state\n  kubectl get pods\n\n  # to check the number of replicas\n  kubectl get hpa\n  ```\n\n- Verify if cluster autoscaler has triggered using the following command.\n\n  ```bash\n  # if it shows Workers > 1 then Cluster Autoscaler has been triggered successfully\n  ibmcloud ks worker-pool ls --cluster <cluster_name_or_ID>\n  ```\n\n  You can check the IBM Cloud Dashboard to confirm if worker nodes are created to meet the current demand. The dashboard will show something like this snapshot.\n  \n  ![Scalingup Nodes](./images/dashboard-scale-up.png)\n\n  It will take few minutes for a new worker node to get ready. You can also follow along with the pod deployment from the command line. You should see the pods transition from pending to running as nodes are scaled up. After sometime all four worker nodes will be up and running. \n\n## Scaling down Worker nodes\n\nThe cluster autoscaler periodically scans the cluster to adjust the number of worker nodes within the worker pools. If the cluster autoscaler detects underutilized worker nodes, it scales down your worker nodes one at a time so that you have only the compute resources that you need.\n\nDecrease the load using the following command.\n\n```bash\nkubectl delete -f generate-load-ca.yaml\n```\n\nWhen the load decreases, the number of pods will also decrease which internally freed up the worker nodes. After a short period of time, the cluster autoscaler detects that your cluster no longer needs all its compute resources and scales down the worker nodes one at a time. Check the Kubernetes dashboard after sometime, you can see the that nodes are getting deleted.\n\n![ScalingDown Nodes](./images/dashboard-scale-down.png)\n\nWe setup 2 as minimum number of worker nodes, it means that the cluster autoscaler does not scale down below two worker nodes  even if you remove the workload that requests the amount. Hence check the dashboard after sometime, it will show as below snapshot.\n\n![Dashboard](./images/dashboard-iks.png)","fileAbsolutePath":"/Users/johandry/Workspace/ibm/att-cloudnative/ibmcloud-pattern-guide/src/pages/deploy-iks/ca/index.mdx"}}}}