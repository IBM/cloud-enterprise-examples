{"version":3,"sources":["webpack:///./src/pages/iac-conf-mgmt/user-data/index.mdx"],"names":["_frontmatter","makeShortcode","name","props","console","warn","PageDescription","AnchorLinks","AnchorLink","InlineNotification","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","small","parentName","isMDXComponent"],"mappings":"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","file":"component---src-pages-iac-conf-mgmt-user-data-index-mdx-2b2d06507628f9d6dc85.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/Users/johandry/Workspace/ibm/att-cloudnative/ibmcloud-pattern-guide/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst PageDescription = makeShortcode(\"PageDescription\");\nconst AnchorLinks = makeShortcode(\"AnchorLinks\");\nconst AnchorLink = makeShortcode(\"AnchorLink\");\nconst InlineNotification = makeShortcode(\"InlineNotification\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <PageDescription mdxType=\"PageDescription\">\n      <p>{`Configure the provisioned instance using User-Data Shell Scripts and Cloud-Init`}</p>\n    </PageDescription>\n    <AnchorLinks small mdxType=\"AnchorLinks\">\n  <AnchorLink mdxType=\"AnchorLink\">Shell Scripts</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Cloud-Init Directives</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Cloud-Init Modules</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Variables Interpolation & Templates</AnchorLink>\n    </AnchorLinks>\n    <p>{`User Data is used to perform common automated configuration tasks and run scripts after the instance starts. This data can be plain text or base64 encoded, the latter is required when we use the IBM Cloud API. The content of the User-Data is sent to the Cloud-Init service of the provisioned instance.`}</p>\n    <p>{`Cloud-Init is the de facto industry standard for early-stage initialization of virtual machines in the cloud. There are two common formats of user data: Shell Scripts and Cloud-Init directives.`}</p>\n    <InlineNotification mdxType=\"InlineNotification\">\n      <p><strong parentName=\"p\">{`What other formats are supported?`}</strong></p>\n      <p>{`Shell scripts and Cloud-Init directive are the most common, however, they are not the only user-data formats supported. Cloud-Init also supports `}<a parentName=\"p\" {...{\n          \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/format.html#include-file\"\n        }}>{`Include Files`}</a>{`, `}<a parentName=\"p\" {...{\n          \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/format.html#upstart-job\"\n        }}>{`Upstart Jobs`}</a>{`, `}<a parentName=\"p\" {...{\n          \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/format.html#cloud-boothook\"\n        }}>{`Cloud Boothooks`}</a>{` and `}<a parentName=\"p\" {...{\n          \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/format.html#part-handler\"\n        }}>{`Part Handler`}</a>{`.`}</p>\n      <p>{`You can also disable User-Data using the directive `}<inlineCode parentName=\"p\">{`allow_userdata: false`}</inlineCode>{` to avoid accepting future deployed user-data.`}</p>\n    </InlineNotification>\n    <h2>{`Shell Scripts`}</h2>\n    <p>{`This is the easiest way to send commands to an instance to execute once it has started. It’s very important the shell script starts with a `}<a parentName=\"p\" {...{\n        \"href\": \"https://bash.cyberciti.biz/guide/Shebang\"\n      }}>{`shebang`}</a>{`, the `}<inlineCode parentName=\"p\">{`#!`}</inlineCode>{` characters followed by a path pointing to the interpreter to execute the script. This script is commonly Bash (`}<inlineCode parentName=\"p\">{`#! /bin/bash`}</inlineCode>{`) but could be any scripting language like Python or Perl, as long as the interpreter is pre-installed in your instance. It’s also very common to use the `}<inlineCode parentName=\"p\">{`env`}</inlineCode>{` command in the shebang pointing to the interpreter like this `}<inlineCode parentName=\"p\">{`#!/usr/bin/env bash`}</inlineCode>{`.`}</p>\n    <p>{`The script is executed as `}<inlineCode parentName=\"p\">{`root`}</inlineCode>{` user, so there is no need to use the `}<inlineCode parentName=\"p\">{`sudo`}</inlineCode>{` command. This means the files created are owned by `}<inlineCode parentName=\"p\">{`root`}</inlineCode>{` so make sure to assign the right owner and permissions once they are created. Avoid commands that require user input, make sure the scripts run non-interactively, using the appropriate command parameters (i.e. `}<inlineCode parentName=\"p\">{`-y`}</inlineCode>{`) to make them non-interactive or use commands like `}<inlineCode parentName=\"p\">{`yes`}</inlineCode>{`.`}</p>\n    <p>{`Notice that when Terraform or Schematics gets the instance up and running the user data script starts and Terraform continues with the provisioning of the other resources. This means the user data shell script is being executed in parallel to other Terraform provisioning and in some cases after Terraform completes. As needed depending on the script, allow some time after Terraform is done to verify the shell script is complete.`}</p>\n    <p>{`If something goes wrong or you’d like to see the status of the script execution check the log file at `}<inlineCode parentName=\"p\">{`/var/log/cloud-init-output.log`}</inlineCode>{`. It may be useful to set the `}<inlineCode parentName=\"p\">{`-x`}</inlineCode>{` option to `}<a parentName=\"p\" {...{\n        \"href\": \"https://tldp.org/LDP/Bash-Beginners-Guide/html/sect_02_03.html\"\n      }}>{`debug bash scripts`}</a>{` or to know what command is being executed, as the log file only shows the output of the commands by default. Set the `}<inlineCode parentName=\"p\">{`-x`}</inlineCode>{` option in the shebang or enable/disable the debug option in part of the code using `}<inlineCode parentName=\"p\">{`set`}</inlineCode>{`, like so:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`#!/bin/bash -x\n\n# Or using set:\nset -x    # enable debugging\necho \"do something here\"\nset +x    # disable debugging\n`}</code></pre>\n    <p>{`The execution of the shell script is performed by Cloud-Init. The content of the script is copied to a file located in `}<inlineCode parentName=\"p\">{`/var/lib/cloud/instances/instance-id/`}</inlineCode>{`. After the execution the script is not deleted, so you can use it for debugging or future execution. However if it’s not needed, or if it has sensitive information, it’s recommended to delete it. For additional debugging options check the Cloud-Init section below.`}</p>\n    <p>{`The user data or Cloud-Init script is only executed during the provisioning of the instance. If the instance is rebooted the script is not executed again, however, this can be changed using Cloud-Init directives.`}</p>\n    <p>{`Here is one example of a user data script from the terraform compute resource example:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-hcl\"\n      }}>{`resource \"ibm_is_instance\" \"iac_app_instance\" {\n  ...\n  user_data = <<-EOUD\n            #!/bin/bash\n            echo '\\${data.local_file.db.content_base64}' | base64 --decode > /var/lib/db.min.json\n\n            # https://askubuntu.com/questions/1154892/prevent-question-restart-services-during-package-upgrades-without-asking\n            echo '* libraries/restart-without-asking boolean true' | debconf-set-selections\n\n            apt update\n            curl -sL https://deb.nodesource.com/setup_13.x | sudo -E bash -\n            apt-get install -y nodejs\n            npm install -g json-server\n\n            json-server --watch /var/lib/db.min.json --port \\${var.port} --host 0.0.0.0 &\n            EOUD\n  ...\n}\n`}</code></pre>\n    <h2>{`Cloud-Init Directives`}</h2>\n    <p>{`All the data passed in the `}<inlineCode parentName=\"p\">{`user_data`}</inlineCode>{` parameter is interpreted by Cloud-Init, even if it’s a shell script as in the previous section. However, Cloud-Init can do more tasks than execute a script and it accepts multiple configuration settings.`}</p>\n    <p>{`Cloud-Init directives are also sent with the `}<inlineCode parentName=\"p\">{`user_data`}</inlineCode>{` parameter in the same way that a script is provided, but the syntax is different. The data begins with `}<inlineCode parentName=\"p\">{`#cloud-config`}</inlineCode>{` (this is not a shebang) and must be valid YAML syntax.`}</p>\n    <p>{`When Cloud-Init starts it runs a collection of modules, these modules are listed in the `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html\"\n      }}>{`Cloud-Init documentation`}</a>{` and they are configured using directives in YAML syntax. Some modules are executed by IBM Cloud such as the SSH module to setup the SSH Keys to allow you to login to the instances, and Mounts to mount the given volumes to the instance. The most common tasks that are done with Cloud-Init are achieved using modules.`}</p>\n    <p>{`The example used in the `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/iac/getting-started-terraform\"\n      }}>{`Getting Started with Terraform`}</a>{` is provided as a bash script, the same code using Cloud-Init would be:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yaml\"\n      }}>{`#cloud-config\nwrite_files:\n  - content: |\n      Hello World\n    path: /index.html\nruncmd:\n  - nohup busybox httpd -f -p 8080 &\n`}</code></pre>\n    <p>{`Cloud-Init directives must begin with `}<inlineCode parentName=\"p\">{`#cloud-config`}</inlineCode>{`, then followed by the the module directives. In this example we use the `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#write-files\"\n      }}>{`Write File`}</a>{` module to write the text `}<inlineCode parentName=\"p\">{`Hello World`}</inlineCode>{` under the parameter `}<inlineCode parentName=\"p\">{`content`}</inlineCode>{` into the file `}<inlineCode parentName=\"p\">{`/index.html`}</inlineCode>{` specified by the parameter `}<inlineCode parentName=\"p\">{`path`}</inlineCode>{`. Then we use the module `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#runcmd\"\n      }}>{`Runcmd`}</a>{` to execute a list of command(s) (in this example, a list has just one command).`}</p>\n    <p>{`Cloud-Init has five `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/boot.html\"\n      }}>{`boot stages`}</a>{` and for every stage there are modules executed in an specific order. The file `}<inlineCode parentName=\"p\">{`/etc/cloud/cloud.cfg`}</inlineCode>{` can be modified during the `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/iac/packer\"\n      }}>{`image build phase`}</a>{` to configure the boot stages, the modules to load and execution order. The sections to modify in the `}<inlineCode parentName=\"p\">{`/etc/cloud/cloud.cfg`}</inlineCode>{` file to change the modules to load and execution order are:`}</p>\n    <ul>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`cloud_init_modules`}</inlineCode>{` runs the `}<inlineCode parentName=\"li\">{`disk_setup`}</inlineCode>{` and `}<inlineCode parentName=\"li\">{`mounts`}</inlineCode>{` modules during the `}<strong parentName=\"li\">{`Network`}</strong>{` stage`}</li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`cloud_config_modules`}</inlineCode>{` runs the config modules, including the `}<inlineCode parentName=\"li\">{`runcmd`}</inlineCode>{` module, during the `}<strong parentName=\"li\">{`Config`}</strong>{` stage`}</li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`cloud_final_modules`}</inlineCode>{` runs scripts and modules for package installation, configuration management (i.e. puppet, chef) and user scripts. This happens during the `}<strong parentName=\"li\">{`Final`}</strong>{` stage.`}</li>\n    </ul>\n    <p>{`The `}<inlineCode parentName=\"p\">{`/etc/cloud/cloud.cfg`}</inlineCode>{` file also includes configuration data about which user will run Cloud-Init, data sources, and vendor data.`}</p>\n    <h2>{`Cloud-Init Modules`}</h2>\n    <p>{`Here are some of the most used Cloud-Init modules and examples. For the entire list of modules and details refer to the `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html\"\n      }}>{`Cloud-Init Modules documentation`}</a>{`.`}</p>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#users-and-groups\"\n          }}>{`Users and Groups`}</a>{` defines new users with the key `}<inlineCode parentName=\"p\">{`users`}</inlineCode>{` and new groups with the key `}<inlineCode parentName=\"p\">{`groups`}</inlineCode>{`.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`users:\n  - name: jsmith\n    groups: sudo\n    shell: /bin/bash\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n    ssh-authorized-keys:\n      - ssh-rsa AAAA....\n  - name: johnsm\n    sudo: false\ngroups:\n  - dbadmin: johnsm\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#set-passwords\"\n          }}>{`Change Passwords`}</a>{` change or remove the password of an existing user, and enable/disable SSH password authentication. This module use the directive `}<inlineCode parentName=\"p\">{`ssh_pwauth`}</inlineCode>{`, `}<inlineCode parentName=\"p\">{`chpasswd`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`password`}</inlineCode>{`. Notice that using `}<inlineCode parentName=\"p\">{`RANDOM`}</inlineCode>{` or `}<inlineCode parentName=\"p\">{`R`}</inlineCode>{` generate a random password visible in the `}<inlineCode parentName=\"p\">{`/var/log/cloud-init-output.log`}</inlineCode>{` log file.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`password: defaultInsecurePasswd\nchpasswd:\n  list: |\n    johnsm:Sup3rP@ssw0rd\n    jsmith:Th3-B35t_P@ssW0rd-Ev3r!\n    httpuser:RANDOM\n  expire: False\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#write-files\"\n          }}>{`Write Files`}</a>{` creates or appends the given content a file at the given path. The file can be encoded (base64, gzip, or both) with optional permissions and owner. All the parameters but `}<inlineCode parentName=\"p\">{`path`}</inlineCode>{` are optional.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`write_files:\n  - path: /test.txt\n    content: |\n      Here is a line.\n      Another line is here.\n  - path: /var/lib/db.min.json\n    content: {\"movies\": []}\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#package-update-upgrade-install\"\n          }}>{`Update or Install Packages`}</a>{` allows packages to be updated, upgraded or installed during boot using the keys `}<inlineCode parentName=\"p\">{`packages`}</inlineCode>{`, `}<inlineCode parentName=\"p\">{`package_update`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`package_upgrade`}</inlineCode>{`. If a package requires reboot use the directive `}<inlineCode parentName=\"p\">{`package_reboot_if_required`}</inlineCode>{`. Use module `}<a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#apt-configure\"\n          }}>{`Apt Configure`}</a>{` to add source list and configure `}<inlineCode parentName=\"p\">{`apt`}</inlineCode>{` if you are on Ubuntu or Debian based OS, for RedHat use the module `}<a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#yum-add-repo\"\n          }}>{`Yum Add Repo`}</a>{`.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`packages:\n    - curl\n    - nodejs\n    - [libpython2.7, 2.7.3-0ubuntu3.1]\npackage_update: True\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#ssh\"\n          }}>{`SSH Configuration`}</a>{` used to manage SSH keys: assign them to users with `}<inlineCode parentName=\"p\">{`ssh_authorized_keys`}</inlineCode>{` and generate keys with `}<inlineCode parentName=\"p\">{`ssh_keys`}</inlineCode>{`. This module is always executed by IBM Cloud when an instance is created to assign the SSH Keys.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`ssh_keys:\n  rsa_private: |\n    -----BEGIN RSA PRIVATE KEY-----\n    your_rsa_private_key\n    -----END RSA PRIVATE KEY-----\n\n  rsa_public: your_rsa_public_key\ndisable_root: True\nssh_authorized_keys:\n    - ssh-rsa AAAA...\n    - ssh-rsa AA3N...\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#ca-certs\"\n          }}>{`Trusted CA Certificates`}</a>{` to add CA certificates to `}<inlineCode parentName=\"p\">{`/etc/ca-certificates.conf`}</inlineCode>{` and update the SSL cert cache.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`ca-certs:\n  remove-defaults: True\n  trusted:\n    - |\n      -----BEGIN CERTIFICATE-----\n      your_CA_cert\n      -----END CERTIFICATE-----\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#resolv-conf\"\n          }}>{`Configure DNS`}</a>{` uses the directive `}<inlineCode parentName=\"p\">{`resolv_conf`}</inlineCode>{` to configure the DNS service file `}<inlineCode parentName=\"p\">{`resolv.conf`}</inlineCode>{` to use your own DNS server. MAke sure the directive `}<inlineCode parentName=\"p\">{`manage-resolv-conf`}</inlineCode>{` is set to True. If there is no DNS server but you need all the instancess know each other, you can use other Hashicorp tools such as `}<a parentName=\"p\" {...{\n            \"href\": \"https://www.serf.io\"\n          }}>{`Serf`}</a>{` or `}<a parentName=\"p\" {...{\n            \"href\": \"https://www.consul.io\"\n          }}>{`Consul`}</a>{` to create a cluster of instances, collect the IP address of each node and add them to `}<inlineCode parentName=\"p\">{`/etc/hosts`}</inlineCode>{`.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`manage_resolv_conf: True\nresolv_conf:\n    nameservers: ['8.8.4.4', '8.8.8.8']\n    searchdomains:\n        - foo.example.com\n        - bar.example.com\n    domain: example.com\n    options:\n        rotate: True\n        timeout: 1\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#set-hostname\"\n          }}>{`Hostname`}</a>{` & `}<a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#update-etc-hosts\"\n          }}>{`Etc Hosts`}</a>{` are used to set the instance hostname, domain name (`}<inlineCode parentName=\"p\">{`fqdn`}</inlineCode>{`) and update them in the `}<inlineCode parentName=\"p\">{`/etc/hosts`}</inlineCode>{` file. It allows you to use a template for the /etc/hosts file located in `}<inlineCode parentName=\"p\">{`/etc/cloud/templates/hosts.tmpl`}</inlineCode>{`. It’s important note that if `}<inlineCode parentName=\"p\">{`manage_etc_hosts`}</inlineCode>{` is set the `}<inlineCode parentName=\"p\">{`/etc/hosts`}</inlineCode>{` file will be updated in every boot, so any change to this file has to be done in the template.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`hostname: app-node\nfqdn: app-node.example.com\nmanage_etc_hosts: true\n`}</code></pre>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\"><a parentName=\"p\" {...{\n            \"href\": \"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#runcmd\"\n          }}>{`Run Commands`}</a>{` is very helpful when there is no module for a required task. Using the directive `}<inlineCode parentName=\"p\">{`runcmd`}</inlineCode>{` you can execute one or multiple commands. The string with the command to execute are passed to the `}<inlineCode parentName=\"p\">{`sh`}</inlineCode>{` shell process to run. The output of all the commands will be logged to the file `}<inlineCode parentName=\"p\">{`/var/log/cloud-init-output.log`}</inlineCode>{`.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-yaml\"\n          }}>{`runcmd:\n  - [ npm, install, -g, json-server]\n  - json-server --watch /var/lib/db.min.json --port 8080 --host 0.0.0.0 &\n`}</code></pre>\n      </li>\n    </ul>\n    <h2>{`Variables Interpolation & Templates`}</h2>\n    <p>{`When a Shell Script or Cloud-Init Directive are used with User-Data in Terraform they can include Terraform variables (input or local variables) or data sources. For example:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-hcl\"\n      }}>{`resource \"ibm_is_instance\" \"iac_app_instance\" {\n  ...\n  user_data = <<-EOUD\n            #cloud-config\n            packages:\n              - curl\n              - python3-pip\n            package_update: True\n            write_files:\n              - path: /var/lib/db.min.json\n                content: \\${data.local_file.db.content}\n            runcmd:\n              - [ pip3, install, json-server.py ]\n              - json-server -b :\\${var.port} /var/lib/db.min.json &\n            EOUD\n  ...\n}\n`}</code></pre>\n    <p>{`A best practice and very common way to use User-Data is to have a local variable to store the user data (shell script or cloud-init directives) and set it to the `}<inlineCode parentName=\"p\">{`user_data`}</inlineCode>{` parameter. This variable can have the content hard-coded in the Terraform code or can be read from a file or template.`}</p>\n    <p>{`For example, placing the User-Data Shell Script in the `}<inlineCode parentName=\"p\">{`scripts/init.sh`}</inlineCode>{` file:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\",\n        \"metastring\": \"path=scripts/init.sh\",\n        \"path\": \"scripts/init.sh\"\n      }}>{`#!/bin/bash\necho \"'\\${json_db_b64}'\" | base64 --decode > /var/lib/db.min.json\n\n# https://askubuntu.com/questions/1154892/prevent-question-restart-services-during-package-upgrades-without-asking\necho '* libraries/restart-without-asking boolean true' | debconf-set-selections\n\napt update\napt install -y python3-pip\npip3 install json-server.py\n\njson-server -b :\\${port} /var/lib/db.min.json &\n`}</code></pre>\n    <p>{`Then we can reference and use the `}<inlineCode parentName=\"p\">{`scripts/init.sh`}</inlineCode>{` like a template using the `}<inlineCode parentName=\"p\">{`templatefile`}</inlineCode>{` function to set the `}<inlineCode parentName=\"p\">{`user_data`}</inlineCode>{` parameter, like this.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-hcl\"\n      }}>{`resource \"ibm_is_instance\" \"iac_app_instance\" {\n  ...\n  user_data = templatefile(\"\\${path.module}/scripts/init.sh\", { json_db_b64 = data.local_file.db.content_base64, port = var.port })\n  ...\n}\n`}</code></pre>\n    <p>{`If you are using Terraform 0.11 or lower you need to use the `}<a parentName=\"p\" {...{\n        \"href\": \"https://www.terraform.io/docs/providers/template/d/file.html\"\n      }}><inlineCode parentName=\"a\">{`template_file`}</inlineCode></a>{` data source instead of the `}<inlineCode parentName=\"p\">{`templatefile`}</inlineCode>{` function.`}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}