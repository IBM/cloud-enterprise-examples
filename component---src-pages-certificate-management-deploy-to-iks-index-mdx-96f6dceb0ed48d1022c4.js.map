{"version":3,"sources":["webpack:///./src/pages/certificate-management/deploy-to-iks/index.mdx"],"names":["_frontmatter","makeShortcode","name","props","console","warn","PageDescription","AnchorLinks","AnchorLink","InlineNotification","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","parentName","small","isMDXComponent"],"mappings":"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","file":"component---src-pages-certificate-management-deploy-to-iks-index-mdx-96f6dceb0ed48d1022c4.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/Users/johandry/Workspace/ibm/att-cloudnative/ibmcloud-pattern-guide/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst PageDescription = makeShortcode(\"PageDescription\");\nconst AnchorLinks = makeShortcode(\"AnchorLinks\");\nconst AnchorLink = makeShortcode(\"AnchorLink\");\nconst InlineNotification = makeShortcode(\"InlineNotification\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    {\n      /*\n      The pattern to document the resources is like follow:\n      - Introduce the resource with an example\n      - List all or the most important input parameters\n      - If will be used, list the most important output parameters\n      - Provide instructions to get the value of the input parameters, either using `ibmcloud`, API or the Web console.\n      - If needed, instructions to execute the code either with Terraform or Schematics\n      */\n    }\n    <PageDescription mdxType=\"PageDescription\">\n      <p>{`Deploying certificates to IBM Kubernetes Clusters`}</p>\n    </PageDescription>\n    <p>{`The Certificate Manager service provides support for deploying certificates to multiple IBM Cloud services. This section reviews how to deploy certificates as secrets to Kubernetes and OpenShift clusters and use them with Kubernetes ingress resources.`}</p>\n    <p>{`The example will use the certificate imported in the `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/certificate-management/service-setup\"\n      }}>{`service setup`}</a>{` section. Modified terraform code from `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/iac-resources/container\"\n      }}>{`IaC containers`}</a>{` will be used to create the kubernetes cluster. The modification reduces the cluster to a single zone with two workers as this is sufficient for demonstrating the custom TLS ingress use case.`}</p>\n    <p>{`The code to manage the creation of the example can be found in the GitHub repository `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/IBM/cloud-enterprise-examples/\"\n      }}>{`https://github.com/IBM/cloud-enterprise-examples/`}</a>{` in the directory `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/IBM/cloud-enterprise-examples/tree/master/iac/14-certificate-management/iks-ingress-certificate\"\n      }}>{`14-certificate-management/iks-ingress-certificate`}</a>{`.`}</p>\n    <AnchorLinks small mdxType=\"AnchorLinks\">\n  <AnchorLink mdxType=\"AnchorLink\">Create Kubernetes Cluster</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Import certificate from Certificate Manager</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Deploy example application with custom TLS in ingress</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Clean up</AnchorLink>\n    </AnchorLinks>\n    <InlineNotification mdxType=\"InlineNotification\">\n      <p><strong parentName=\"p\">{`Requirements`}</strong></p>\n      <p>{`To be able to execute and complete the instructions in this page, make sure you have an `}<strong parentName=\"p\">{`IBM Cloud account`}</strong>{`: if you donâ€™t have one yet, you can `}<a parentName=\"p\" {...{\n          \"href\": \"https://cloud.ibm.com/docs/overview?topic=overview-quickstart_lite#prereqs-lite\"\n        }}>{`create a Lite account`}</a>{` for free.`}</p>\n      <p>{`These examples will require an internet DNS domain that is managed by the user or can be used with a domain managed by the IBM Cloud Internet Services service.`}</p>\n      <p>{`Also make sure you have the environment setup as explained in the `}<a parentName=\"p\" {...{\n          \"href\": \"/cloud-enterprise-examples/iac/setup-environment\"\n        }}>{`Setup Environment`}</a>{` page to have installed the IBM Cloud CLI, logged in to your account with the IBM Cloud CLI and set the `}<inlineCode parentName=\"p\">{`IC_API_KEY`}</inlineCode>{` environment variable to a key which has the ability to manage IAM configuration.`}</p>\n    </InlineNotification>\n    <h2>{`Create Kubernetes Cluster`}</h2>\n    <p>{`In order to demostrate the use of certificates from the Certificate Manager service in the IBM Kubernetes Service (IKS), a kubernetes cluster with an example application is required. For this guide, the example terraform code to create the cluster and the application deployment resources will be reused from the `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/iac-resources/container\"\n      }}>{`IaC containers`}</a>{` pattern.`}</p>\n    <p>{`Before you run through this example, make sure your Terraform environment is setup correctly as documented in the `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/iac/setup-environment\"\n      }}>{`environment setup`}</a>{`.`}</p>\n    <p>{`Change into the `}<inlineCode parentName=\"p\">{`14-certificate-management/iks-ingress-certificate`}</inlineCode>{` directory and run the following commands to create an IKS cluster.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`terraform init \nterraform plan \nterraform apply\n`}</code></pre>\n    <p>{`A single-zone cluster will be created with two worker nodes. This will take some time as the cluster deploys. When finished the cluster name will be displayed. Set this to an envrionment variable for later use from the command line:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`IKS_CLUSTER=$(terraform output cluster_name)\n`}</code></pre>\n    <h2>{`Import certificate from Certificate Manager`}</h2>\n    <p>{`Deploying certificates from the Certificate Manager service to a kubernetes cluster can be performed from the IBM Cloud CLI using the container service plugin command `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloud.ibm.com/docs/cli?topic=containers-cli-plugin-kubernetes-service-cli#cs_alb_cert_deploy\"\n      }}><inlineCode parentName=\"a\">{`ibmcloud ks alb cert deploy`}</inlineCode></a>{`.`}</p>\n    <p>{`Alternatively, the certificate may also be added using a resource and terraform code. To do this, the CRN of the desired certificate in Certificate Manager is needed. This example will use the certificate that was imported in the Certificate Manager `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/certificate-management/service-setup\"\n      }}>{`service setup`}</a>{`.`}</p>\n    <p>{`Change to the `}<inlineCode parentName=\"p\">{`14-certificate-management/import-certificate`}</inlineCode>{` directory and obtain the CRN of the ordered certificate:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`cd ../import-certificate\nCERT_CRN=$(terraform output imported-certificate-id)\n`}</code></pre>\n    <p>{`Return to the `}<inlineCode parentName=\"p\">{`14-certificate-management/iks-ingress-certificate`}</inlineCode>{` directory and create a terraform resource file for the tls certificate (the secret in this example is named after the wildcard domain from the imported certificate, it can be changed as desired):`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`cat > tls.tf <<EOF\nresource ibm_container_alb_cert cert {\n  cert_crn    = \"$CERT_CRN\"\n  secret_name = \"tls-cm-timro-us\"\n  cluster_id  = ibm_container_vpc_cluster.iac_iks_cluster.id\n}\nEOF\n`}</code></pre>\n    <p>{`Verify and apply the code to add the certificate information as a secret in the IKS cluster:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`terraform plan\nterraform apply\n`}</code></pre>\n    <p>{`Verify the secret in the cluster. Configure the kubectl context with access to the IKS cluster using the `}<inlineCode parentName=\"p\">{`ibmcloud ks cluster config`}</inlineCode>{` command. Then verify the secret in the `}<inlineCode parentName=\"p\">{`default`}</inlineCode>{` namespace.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`ibmcloud ks cluster config --cluster $IKS_CLUSTER\nkubectl get secrets -n default\n`}</code></pre>\n    <p>{`The secret as named in the `}<inlineCode parentName=\"p\">{`tls.tf`}</inlineCode>{` file will be shown along with other secrets in the default namespace. The secret created in the `}<inlineCode parentName=\"p\">{`default`}</inlineCode>{` namespace is a reference to the actual secret which is maintained in the `}<inlineCode parentName=\"p\">{`ibm-cert-store`}</inlineCode>{` namespace. This secret can be read by ingress resources created in `}<strong parentName=\"p\">{`any`}</strong>{` namespace of the cluster.`}</p>\n    <h2>{`Deploy example application with custom TLS in ingress`}</h2>\n    <p>{`Update the `}<inlineCode parentName=\"p\">{`kubernetes/deployment.yaml`}</inlineCode>{` resource file to point to the container image that you created in the `}<a parentName=\"p\" {...{\n        \"href\": \"/cloud-enterprise-examples/iac-resources/container\"\n      }}>{`IaC container`}</a>{` pattern. The actual application used is not important, so if you prefer to use another container image, it is ok to substitute.`}</p>\n    <p>{`Next, update the `}<inlineCode parentName=\"p\">{`kubernetes/ingress-tls.yaml`}</inlineCode>{` file with the domain name and tls secret used. Continuing with the example domain used for the Certificate Manager import and the secret as named above, the ingress file would have the following content:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yaml\",\n        \"metastring\": \"pathname=ingress-tls.yaml\",\n        \"pathname\": \"ingress-tls.yaml\"\n      }}>{`apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: movies-ingress\nspec:\n  tls:\n  - hosts:\n      - movies.cm.timro.us\n    secretName: tls-cm-timro-us\n  rules:\n  - host: movies.cm.timro.us\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: movies\n          servicePort: 80\n`}</code></pre>\n    <p>{`For this example scenario, the imported certificate is a wildcard for `}<inlineCode parentName=\"p\">{`*.cm.timro.us`}</inlineCode>{` allowing any host name to be added to the `}<inlineCode parentName=\"p\">{`cm.timro.us`}</inlineCode>{` subdomain.`}</p>\n    <p>{`Create the application deployment, create the service and the ingress with the TLS certificate. The resource files are located in the `}<inlineCode parentName=\"p\">{`14-certificate-management/iks-ingress-certificate/kubernetes`}</inlineCode>{` directory.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`cd kubernetes\nkubectl create -f deployment.yaml\nkubectl create -f service.yaml\nkubectl create -f ingress-tls.yaml\n`}</code></pre>\n    <p>{`The final step is to configure a CNAME in the DNS for the hostname specified in the ingress that directs the connection to the VPC load balancer for the IKS cluster. Obtain the hostname with:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`kubectl get ingress movies-ingress -o json | jq .status.loadBalancer.ingress[0].hostname\n`}</code></pre>\n    <p>{`After the CNAME is added, you will be able to reach the application.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`curl https://movies.cm.timro.us/movies/675\n{\n  \"id\": \"675\",\n  \"title\": \"Kagemusha\",\n...\n`}</code></pre>\n    <h2>{`Clean up`}</h2>\n    <p>{`To cleanup all the resources created by the script, run the following:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`terraform destroy\n`}</code></pre>\n    <p>{`This will not remove the Certificate Manager instance and certificates that have been imported or ordered. If the service is no longer needed, it may be deleted using the IBM Cloud web UI or from the command line:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`ibmcloud resource service-instance-delete \"iac-certificate-manager\"\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}